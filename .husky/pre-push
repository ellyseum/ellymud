# Pre-push hook with branch-aware testing
# - Feature branches: Lint + prettier only (rely on GitHub Actions for tests)
# - Main branch: Full test suite (no CI safety net for direct pushes)

# Skip checks for branch deletions
# Pre-push hook receives: <local ref> <local sha> <remote ref> <remote sha>
# For deletions, local_sha is all zeros
while read local_ref local_sha remote_ref remote_sha; do
  if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
    echo "ğŸ—‘ï¸  Branch deletion detected - skipping checks"
    exit 0
  fi
done

# Get the current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸ“Œ Pushing branch: $BRANCH"

# Check paired documentation
echo "ğŸ“ Checking paired documentation..."
./scripts/check-paired-docs.sh --all

# Always run formatting/lint checks
echo "ğŸ” Checking formatting..."
npx prettier --check 'src/**/*.ts'

echo "ğŸ” Running ESLint..."
npx eslint 'src/**/*.ts' --max-warnings 0

# Branch-specific testing
if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  echo ""
  echo "âš ï¸  Pushing directly to $BRANCH - running full test suite..."
  echo ""
  
  echo "ğŸ”¨ Building..."
  npm run build
  
  echo "ğŸ§ª Running unit tests..."
  npm run test:unit
  
  echo "ğŸ§ª Running E2E tests..."
  npm run test:e2e
  
  echo "ğŸ§ª Running integration tests..."
  npm run test:integration
  
  echo ""
  echo "âœ… All pre-push checks passed for $BRANCH!"
else
  echo ""
  echo "ğŸš€ Feature branch detected - skipping tests (GitHub Actions will run them)"
  echo "âœ… Pre-push checks passed for $BRANCH!"
fi

