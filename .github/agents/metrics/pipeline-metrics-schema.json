{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Pipeline Metrics",
  "description": "Schema for tracking agent pipeline execution metrics. Aggregates individual stats from metrics/stats/ directory.",
  "type": "object",
  "required": ["pipelineId", "task", "date", "stages", "outcome"],
  "properties": {
    "pipelineId": {
      "type": "string",
      "description": "Unique identifier for this pipeline execution",
      "pattern": "^pipe-\\d{4}-\\d{2}-\\d{2}-\\d{3}$",
      "examples": ["pipe-2025-12-21-001"]
    },
    "task": {
      "type": "string",
      "description": "Description of the task being executed",
      "minLength": 5,
      "maxLength": 200
    },
    "date": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of pipeline start"
    },
    "endDate": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of pipeline completion"
    },
    "branch": {
      "type": "string",
      "description": "Git branch where changes were made",
      "examples": ["feature/npc-dialogue", "fix/combat-damage"]
    },
    "complexity": {
      "type": "string",
      "enum": ["Trivial", "Low", "Medium", "High", "Critical"],
      "description": "Complexity level determined at triage"
    },
    "mode": {
      "type": "string",
      "enum": ["Instant", "Fast-Track", "Standard", "Full"],
      "description": "Pipeline mode used based on complexity"
    },
    "stages": {
      "type": "object",
      "description": "Metrics for each pipeline stage. Aggregated from individual stats files in metrics/stats/",
      "properties": {
        "research": { "$ref": "#/definitions/stageMetrics" },
        "planning": { "$ref": "#/definitions/stageMetrics" },
        "implementation": { "$ref": "#/definitions/stageMetrics" },
        "validation": { "$ref": "#/definitions/stageMetrics" },
        "review": { "$ref": "#/definitions/stageMetrics" },
        "postMortem": { "$ref": "#/definitions/stageMetrics" },
        "documentation": { "$ref": "#/definitions/stageMetrics" }
      }
    },
    "statsFiles": {
      "type": "object",
      "description": "References to individual agent stats files in metrics/stats/",
      "properties": {
        "pipeline": { "type": "string", "description": "Path to pipeline orchestrator stats" },
        "research": { "type": "string", "description": "Path to research agent stats" },
        "planning": { "type": "string", "description": "Path to planning agent stats" },
        "implementation": { "type": "string", "description": "Path to implementation agent stats" },
        "validation": { "type": "string", "description": "Path to validation agent stats" },
        "review": { "type": "string", "description": "Path to output review stats" },
        "postMortem": { "type": "string", "description": "Path to post-mortem agent stats" },
        "documentation": { "type": "string", "description": "Path to documentation updater stats" },
        "rollback": { "type": "string", "description": "Path to rollback agent stats (if used)" }
      }
    },
    "totalDuration": {
      "type": "integer",
      "description": "Total pipeline duration in minutes",
      "minimum": 0
    },
    "outcome": {
      "type": "string",
      "enum": ["success", "failure", "escalated", "rolled-back", "abandoned"],
      "description": "Final pipeline outcome"
    },
    "tokensEstimate": {
      "type": "integer",
      "description": "Estimated total tokens used across all stages",
      "minimum": 0
    },
    "costEstimate": {
      "type": "number",
      "description": "Estimated cost in USD (optional)",
      "minimum": 0
    },
    "premiumRequests": {
      "type": "object",
      "description": "Premium request tracking for GitHub Copilot billing",
      "properties": {
        "total": {
          "type": "integer",
          "description": "Total premium requests across all stages",
          "minimum": 0
        },
        "byStage": {
          "type": "object",
          "description": "Premium requests broken down by pipeline stage",
          "properties": {
            "research": { "type": "integer", "minimum": 0 },
            "planning": { "type": "integer", "minimum": 0 },
            "implementation": { "type": "integer", "minimum": 0 },
            "validation": { "type": "integer", "minimum": 0 },
            "review": { "type": "integer", "minimum": 0 },
            "postMortem": { "type": "integer", "minimum": 0 },
            "documentation": { "type": "integer", "minimum": 0 },
            "orchestrator": { "type": "integer", "minimum": 0 }
          }
        },
        "byCostTier": {
          "type": "object",
          "description": "Requests grouped by cost tier multiplier",
          "properties": {
            "free": { "type": "integer", "description": "0x tier (GPT-4.1, GPT-4o)", "minimum": 0 },
            "low": { "type": "integer", "description": "0.33x tier (GPT-5 mini, Haiku 4.5, Gemini Flash)", "minimum": 0 },
            "standard": { "type": "integer", "description": "1x tier (Sonnet 4/4.5, Gemini Pro, GPT-5.x)", "minimum": 0 },
            "premium": { "type": "integer", "description": "3x tier (Claude Opus 4.5)", "minimum": 0 }
          }
        },
        "weightedTotal": {
          "type": "number",
          "description": "Total requests weighted by cost tier (0x*0 + 0.33x*0.33 + 1x*1 + 3x*3)",
          "minimum": 0
        }
      }
    },
    "outputs": {
      "type": "object",
      "description": "References to all pipeline output files",
      "properties": {
        "research": { "$ref": "#/definitions/stageOutputFiles" },
        "planning": { "$ref": "#/definitions/stageOutputFiles" },
        "implementation": { "$ref": "#/definitions/stageOutputFiles" },
        "validation": { "$ref": "#/definitions/stageOutputFiles" },
        "postMortem": {
          "type": "object",
          "properties": {
            "suggestions": {
              "type": "string",
              "description": "Path to post-mortem suggestions file"
            },
            "agentUpdates": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Paths to agent files updated based on post-mortem"
            }
          }
        },
        "documentation": {
          "type": "object",
          "properties": {
            "readmeFiles": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Paths to README.md files updated"
            },
            "agentsFiles": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Paths to AGENTS.md files updated"
            }
          }
        }
      }
    },
    "aggregatedFromStats": {
      "type": "object",
      "description": "Metrics aggregated from individual stats files in metrics/stats/",
      "properties": {
        "totalToolCalls": {
          "type": "integer",
          "description": "Sum of all tool calls across all agents",
          "minimum": 0
        },
        "filesProcessed": {
          "type": "object",
          "properties": {
            "read": { "type": "integer", "minimum": 0 },
            "created": { "type": "integer", "minimum": 0 },
            "modified": { "type": "integer", "minimum": 0 },
            "deleted": { "type": "integer", "minimum": 0 }
          }
        },
        "tokenBreakdown": {
          "type": "object",
          "properties": {
            "research": { "type": "integer" },
            "planning": { "type": "integer" },
            "implementation": { "type": "integer" },
            "validation": { "type": "integer" },
            "review": { "type": "integer" },
            "postMortem": { "type": "integer" },
            "documentation": { "type": "integer" },
            "orchestrator": { "type": "integer" }
          }
        },
        "qualityScores": {
          "type": "object",
          "description": "Quality scores extracted from stats files",
          "properties": {
            "researchCitations": {
              "type": "integer",
              "description": "File:line citations in research"
            },
            "planningTasks": { "type": "integer", "description": "Tasks defined in plan" },
            "testsRun": { "type": "integer", "description": "Total tests executed" },
            "testsPassed": { "type": "integer", "description": "Tests that passed" },
            "buildSuccess": { "type": "boolean", "description": "Final build status" }
          }
        }
      }
    },
    "rollback": {
      "type": "object",
      "description": "Rollback details if pipeline was rolled back",
      "properties": {
        "triggered": { "type": "boolean" },
        "reason": { "type": "string" },
        "checkpointId": { "type": "string" },
        "filesReverted": { "type": "integer" }
      }
    },
    "issues": {
      "type": "array",
      "description": "Issues encountered during pipeline",
      "items": {
        "type": "object",
        "properties": {
          "stage": { "type": "string" },
          "severity": { "type": "string", "enum": ["low", "medium", "high", "critical"] },
          "description": { "type": "string" },
          "resolved": { "type": "boolean" }
        }
      }
    },
    "notes": {
      "type": "string",
      "description": "Additional notes about this pipeline execution"
    }
  },
  "definitions": {
    "stageMetrics": {
      "type": "object",
      "description": "Metrics for a single pipeline stage. Duration/tokens aggregated from stats files.",
      "properties": {
        "duration": {
          "type": "integer",
          "description": "Stage duration in minutes (from stats file)",
          "minimum": 0
        },
        "grade": {
          "type": "string",
          "description": "Grade from Output Review Agent (from grade report)",
          "pattern": "^[A-F][+-]?$",
          "examples": ["A", "B+", "C-"]
        },
        "score": {
          "type": "integer",
          "description": "Numeric score (0-100) from grade report",
          "minimum": 0,
          "maximum": 100
        },
        "verdict": {
          "type": "string",
          "enum": ["PASS", "FAIL", "SKIP"],
          "description": "Pass/Fail verdict from grade report (PASS >= 80)"
        },
        "retries": {
          "type": "integer",
          "description": "Number of retry attempts",
          "minimum": 0,
          "default": 0
        },
        "skipped": {
          "type": "boolean",
          "description": "Whether this stage was skipped (Fast-Track mode)",
          "default": false
        },
        "tokensUsed": {
          "type": "integer",
          "description": "Estimated tokens used in this stage (from stats file)",
          "minimum": 0
        },
        "modelUsed": {
          "type": "string",
          "description": "The actual model used for this stage (e.g., 'Claude Opus 4.5')"
        },
        "costTier": {
          "type": "string",
          "enum": ["0x", "0.33x", "1x", "3x"],
          "description": "Cost tier of the model used"
        },
        "premiumRequests": {
          "type": "integer",
          "description": "Number of premium requests made in this stage",
          "minimum": 0
        },
        "statsFile": {
          "type": "string",
          "description": "Path to the agent's stats file in metrics/stats/"
        }
      }
    },
    "stageOutputFiles": {
      "type": "object",
      "description": "Output files produced by a pipeline stage",
      "properties": {
        "original": {
          "type": "string",
          "description": "Path to the original agent output file"
        },
        "reviewed": {
          "type": "string",
          "description": "Path to the reviewed/condensed version (*-reviewed.md)"
        },
        "gradeReport": {
          "type": "string",
          "description": "Path to the grade report from Output Review (*-grade.md)"
        },
        "summary": {
          "type": "string",
          "description": "Path to the summary file if generated (*-summary.md)"
        },
        "changeSuggestions": {
          "type": "string",
          "description": "Path to improvement suggestions (*-suggestions.md)"
        }
      }
    }
  }
}
